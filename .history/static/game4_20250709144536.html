<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä½ç½®è®°å¿†æ¸¸æˆ</title>
    <style>
        /* æ‚¨çš„CSSæ ·å¼å¾ˆæ£’ï¼ŒåŸºæœ¬ä¿æŒä¸å˜ï¼Œåªå¾®è°ƒæŒ‰é’®çŠ¶æ€ */
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f4f8; padding: 20px; }
        h1 { margin-bottom: 20px; color: #333; }
        .grid { display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; justify-content: center; margin: auto; }
        .cell { width: 80px; height: 80px; background-color: #ccc; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .cell.flashed { background-color: #f97316; transform: scale(1.05); }
        .cell.clicked { background-color: #3b82f6; }
        .cell.correct { background-color: #10b981; }
        .cell.wrong { background-color: #ef4444; }
        #message { margin-top: 20px; font-size: 1.5rem; font-weight: bold; min-height: 2em; }
        button { margin-top: 20px; padding: 10px 20px; font-size: 1rem; background-color: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background-color: #2563eb; }
        button:disabled { background-color: #999; cursor: not-allowed; }
    </style>
</head>

<body data-result-id="{{ result_id }}">

    <h1>ä½ç½®è®°å¿†æ¸¸æˆ</h1>
    <div class="grid" id="grid"></div>
    <div id="message">è¯·ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€</div>
    <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>

    <script src="{% static 'jquery-3.7.1.min.js' %}"></script>
    
    <script>
    // å°†æ‰€æœ‰JSä»£ç éƒ½åŒ…è£¹åœ¨ $(document).ready() ä¸­
    $(document).ready(function() {

        // --- 1. æ¸¸æˆçŠ¶æ€å’Œé…ç½® ---
        const gridSize = 4;
        const totalCells = gridSize * gridSize;
        const flashCount = 4;
        let gameState = {}; // ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥ç»Ÿä¸€ç®¡ç†æ¸¸æˆçŠ¶æ€

        // --- DOM å…ƒç´ ç¼“å­˜ ---
        const $grid = $('#grid');
        const $message = $('#message');
        const $startBtn = $('#startBtn');

        // --- 2. æ ¸å¿ƒå‡½æ•° ---

        // åˆå§‹åŒ–/é‡ç½®æ¸¸æˆ
        function initGame() {
            gameState = {
                flashedCells: [],
                userClicks: [],
                isGameActive: false,
                canPlayerClick: false
            };
            
            $grid.html(''); // æ¸…ç©ºç½‘æ ¼
            for (let i = 0; i < totalCells; i++) {
                // ä½¿ç”¨jQueryåˆ›å»ºå…ƒç´ 
                const $cell = $('<div></div>').addClass('cell').data('index', i);
                $grid.append($cell);
            }
            $message.text('è¯·ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€').css('color', '#333');
            $startBtn.prop('disabled', false).text('å¼€å§‹æ¸¸æˆ');
        }

        // å¼€å§‹æ¸¸æˆæµç¨‹
        function startGame() {
            initGame(); // é‡ç½®æ¸¸æˆçŠ¶æ€
            $startBtn.prop('disabled', true); // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            $message.text('è¯·è®°ä½é—ªçƒçš„ä½ç½®...');
            
            // éšæœºé€‰æ‹©è¦é—ªçƒçš„æ ¼å­
            while (gameState.flashedCells.length < flashCount) {
                const rand = Math.floor(Math.random() * totalCells);
                if (!gameState.flashedCells.includes(rand)) {
                    gameState.flashedCells.push(rand);
                }
            }
            
            // é—ªçƒæ ¼å­
            gameState.flashedCells.forEach(index => {
                $(`.cell[data-index="${index}"]`).addClass('flashed');
            });

            // é—ªçƒç»“æŸå
            setTimeout(() => {
                $('.cell').removeClass('flashed'); // ç§»é™¤é—ªçƒæ•ˆæœ
                $message.text('è¯·ä¾æ¬¡ç‚¹å‡»ä½ è®°ä½çš„ä½ç½®');
                gameState.isGameActive = true; // æ¸¸æˆæ­£å¼å¼€å§‹
                gameState.canPlayerClick = true; // ç°åœ¨å…è®¸ç©å®¶ç‚¹å‡»
            }, 1500); // é—ªçƒ1.5ç§’
        }

        // å¤„ç†æ ¼å­ç‚¹å‡»äº‹ä»¶
        function handleCellClick() {
            if (!gameState.canPlayerClick) return;

            const $cell = $(this);
            // é˜²æ­¢é‡å¤ç‚¹å‡»åŒä¸€ä¸ªæ ¼å­
            if ($cell.hasClass('clicked')) return;

            $cell.addClass('clicked');
            gameState.userClicks.push($cell.data('index'));

            // å½“ç©å®¶ç‚¹å‡»äº†è¶³å¤Ÿæ•°é‡çš„æ ¼å­åï¼Œæ£€æŸ¥ç»“æœ
            if (gameState.userClicks.length === flashCount) {
                gameState.canPlayerClick = false; // åœæ­¢ç©å®¶ç‚¹å‡»
                checkResult();
            }
        }

        // æ£€æŸ¥ç»“æœ
        function checkResult() {
            let correctCount = 0;
            const $cells = $('.cell');

            gameState.userClicks.forEach(clickedIndex => {
                const $cell = $cells.filter(`[data-index="${clickedIndex}"]`);
                // æ£€æŸ¥ç©å®¶ç‚¹å‡»çš„æ ¼å­æ˜¯å¦åœ¨å½“åˆé—ªçƒçš„æ ¼å­åˆ—è¡¨é‡Œ
                if (gameState.flashedCells.includes(clickedIndex)) {
                    $cell.addClass('correct');
                    correctCount++;
                } else {
                    $cell.addClass('wrong');
                }
            });

            // è®¡ç®—åˆ†æ•°å¹¶æäº¤
            const finalScore = calculateScore(correctCount);
            if (correctCount === flashCount) {
                $message.text('ğŸ‰ å…¨éƒ¨æ­£ç¡®ï¼è®°å¿†åŠ›çœŸæ£’ï¼').css('color', '#10b981');
            } else {
                $message.text(`âŒ ç­”å¯¹äº† ${correctCount} ä¸ªï¼Œæ€»å…± ${flashCount} ä¸ªã€‚`).css('color', '#ef4444');
            }

            const currentResultId = $('body').data('result-id');
            // æ­¤æ¸¸æˆæµ‹è¯•çš„æ˜¯â€œè®°å¿†â€èƒ½åŠ›
            updateResult(currentResultId, { "memory": finalScore }); 
            
            $startBtn.prop('disabled', false).text('å†ç©ä¸€æ¬¡'); // å…è®¸ç”¨æˆ·é‡ç©
        }

        // âœ… æ–°å¢ï¼šæ ¹æ®è§„åˆ™è®¡ç®—åˆ†æ•°
        function calculateScore(correctCount) {
            // 0å¯¹=50åˆ†, 4å¯¹=100åˆ†ã€‚æ€»åˆ†å·®æ˜¯50ï¼Œåˆ†4æ­¥èµ°å®Œï¼Œæ¯æ­¥12.5åˆ†ã€‚
            const score = 50 + (correctCount * 12.5);
            return Math.round(score);
        }

        // AJAX æ›´æ–°å‡½æ•°
        function updateResult(resultId, dataToUpdate) {
            if (!resultId) {
                console.error("IDä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤åˆ†æ•°!");
                alert("é¡µé¢åˆå§‹åŒ–é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚");
                return;
            }
            $.ajax({
                url: `/api/results/${resultId}/`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify(dataToUpdate),
                success: (response) => {
                    console.log('æ›´æ–°æˆåŠŸ!', response);
                    alert(`åˆ†æ•° ${dataToUpdate.memory} å·²æˆåŠŸæäº¤ï¼`);
                },
                error: (error) => {
                    console.error('æ›´æ–°å¤±è´¥:', error);
                    alert('æäº¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦æƒ…ã€‚');
                }
            });
        }

        // --- 3. äº‹ä»¶ç»‘å®š ---
        $startBtn.on('click', startGame);
        $grid.on('click', '.cell', handleCellClick); // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥ç»‘å®šç‚¹å‡»

        // --- 4. é¡µé¢åˆå§‹åŒ– ---
        initGame(); // åˆå§‹åŒ–æ¸¸æˆé¢æ¿
    });
    </script>
</body>
</html>