<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>è®°å¿†æ£‹ç›˜æ¸¸æˆ (æ—¶é—´è®¡åˆ†ç‰ˆ)</title>
    <style>
        /* CSSæ ·å¼ä¸ä¹‹å‰ç¾åŒ–åçš„ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæ­¤å¤„ä¸ºäº†ç®€æ´çœç•¥ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; text-align: center; background: #f0f4f8; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h1 { margin-bottom: 10px; color: #1f2937; }
        .instructions { color: #4b5563; margin-bottom: 20px; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 15px; justify-content: center; margin: 20px auto; }
        .card { width: 100px; height: 100px; background-color: #3b82f6; color: white; font-size: 3rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 10px; transition: transform 0.4s; transform-style: preserve-3d; }
        .card .card-face { backface-visibility: hidden; position: absolute; }
        .card .card-back { transform: rotateY(180deg); }
        .card.flipped { transform: rotateY(180deg); background-color: #dd8c4e; }
        .card.matched { background-color: #10b981; cursor: default; transform: rotateY(180deg) scale(1.05); }
        #message { margin-top: 20px; font-size: 1.5rem; font-weight: bold; min-height: 1.5em; }
        button { padding: 12px 30px; font-size: 1.1rem; background-color: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #eade5d; cursor: not-allowed; }
    </style>
</head>

<body data-result-id="{{ result_id }}">

<div class="container">
    <h1>è®°å¿†æ£‹ç›˜</h1>
    <p class="instructions">æ‰¾å‡ºæ‰€æœ‰åŒ¹é…çš„å¡ç‰‡é…å¯¹ï¼Œç”¨æ—¶è¶ŠçŸ­ï¼Œå¾—åˆ†è¶Šé«˜ï¼</p>
    <div class="board" id="board"></div>
    <div id="message"></div>
    <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
</div>

<script src="{% static 'jquery-3.7.1.min.js' %}"></script>
<script>
$(document).ready(function() {
    
    // --- 1. æ¸¸æˆçŠ¶æ€å’Œé…ç½® ---
    const gridRows = 2;
    const gridCols = 3;
    const totalPairs = (gridRows * gridCols) / 2;
    let gameState = {};

    // --- DOM å…ƒç´ ç¼“å­˜ ---
    const $board = $('#board');
    const $message = $('#message');
    const $startBtn = $('#startBtn');

    // --- 2. æ ¸å¿ƒå‡½æ•° ---

    function initGame() {
        gameState = {
            cards: generateCardData(),
            flippedCards: [],
            matchedPairs: 0,
            isGameActive: false,
            startTime: 0 // âœ… æ–°å¢ï¼šç”¨äºè®°å½•æ¸¸æˆå¼€å§‹æ—¶é—´
        };
        
        $board.html('');
        gameState.cards.forEach((cardData, index) => {
            const $card = $(`
                <div class="card" data-index="${index}" data-value="${cardData.value}">
                    <div class="card-face card-front"></div>
                    <div class="card-face card-back">${cardData.value}</div>
                </div>
            `);
            $board.append($card);
        });

        $message.text('');
        $startBtn.prop('disabled', false).show().text('å¼€å§‹æ¸¸æˆ');
    }

    function generateCardData() {
        const values = [];
        const symbols = ['â˜…', 'â™¥', 'â™¦'];
        for (let i = 0; i < totalPairs; i++) {
            values.push({ value: symbols[i] }, { value: symbols[i] });
        }
        return values.sort(() => Math.random() - 0.5);
    }

    function startGame() {
        initGame();
        $startBtn.hide();
        $message.text('æ‰¾å‡ºæ‰€æœ‰é…å¯¹ï¼');
        gameState.isGameActive = true;
        // âœ… ä¿®æ”¹ï¼šæ¸¸æˆå¼€å§‹æ—¶ï¼Œè®°å½•å½“å‰æ—¶é—´
        gameState.startTime = Date.now();
    }

    function handleCardClick() {
        if (!gameState.isGameActive || gameState.flippedCards.length >= 2) return;
        
        const $card = $(this);
        if ($card.hasClass('flipped')) return;
        
        $card.addClass('flipped');
        gameState.flippedCards.push($card);
        
        if (gameState.flippedCards.length === 2) {
            checkMatch();
        }
    }

    function checkMatch() {
        const [$card1, $card2] = gameState.flippedCards;
        
        if ($card1.data('value') === $card2.data('value')) {
            $card1.addClass('matched');
            $card2.addClass('matched');
            gameState.matchedPairs++;
            gameState.flippedCards = [];
            
            if (gameState.matchedPairs === totalPairs) {
                finishGame();
            }
        } else {
            setTimeout(() => {
                $card1.removeClass('flipped');
                $card2.removeClass('flipped');
                gameState.flippedCards = [];
            }, 1000);
        }
    }
    
    function finishGame() {
        gameState.isGameActive = false;
        
        // âœ… ä¿®æ”¹ï¼šè®¡ç®—æ¸¸æˆç”¨æ—¶
        const elapsedMilliseconds = Date.now() - gameState.startTime;
        const elapsedSeconds = elapsedMilliseconds / 1000;
        
        // âœ… ä¿®æ”¹ï¼šæ ¹æ®ç”¨æ—¶è®¡ç®—åˆ†æ•°
        const finalScore = calculateScore(elapsedSeconds);
        
        $message.text(`ğŸ‰ å®Œæˆï¼ç”¨æ—¶: ${elapsedSeconds.toFixed(2)}ç§’ï¼Œå¾—åˆ†: ${finalScore}`).css('color', 'green');
        
        const currentResultId = $('body').data('result-id');
        updateResult(currentResultId, { "memory": finalScore });
        
        $startBtn.text('å†ç©ä¸€æ¬¡').show();
    }

    // âœ… ä¿®æ”¹ï¼šå®ç°æ–°çš„è®¡åˆ†å‡½æ•°
    function calculateScore(elapsedSeconds) {
        if (elapsedSeconds <= 30) {
            return 100; // 30ç§’ä»¥å†…éƒ½æ˜¯æ»¡åˆ†
        }
        if (elapsedSeconds >= 300) { // 5åˆ†é’Ÿ = 300ç§’
            return 0;   // è¶…è¿‡5åˆ†é’Ÿéƒ½æ˜¯0åˆ†
        }
        
        // åœ¨30ç§’åˆ°300ç§’ä¹‹é—´ï¼Œåˆ†æ•°ä»100çº¿æ€§é€’å‡åˆ°0
        // æ€»æ—¶é•¿èŒƒå›´ = 300 - 30 = 270ç§’
        // æ¯ç§’æ‰£é™¤çš„åˆ†æ•° = 100åˆ† / 270ç§’
        const score = 100 - ((elapsedSeconds - 30) / 270) * 100;
        
        return Math.round(score); // è¿”å›ä¸€ä¸ªæ•´æ•°
    }

    // AJAX æ›´æ–°å‡½æ•° (ä¿æŒä¸å˜)
    function updateResult(resultId, dataToUpdate) {
        if (!resultId) { console.error("IDä¸å­˜åœ¨!"); return; }
        $.ajax({
            url: `/api/results/${resultId}/`,
            type: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify(dataToUpdate),
            success: (response) => {
                console.log('æ›´æ–°æˆåŠŸ!', response);
                alert(`åˆ†æ•° ${dataToUpdate.memory} å·²æˆåŠŸæäº¤ï¼`);
            },
            error: (error) => console.error('æ›´æ–°å¤±è´¥:', error)
        });
    }

    // --- äº‹ä»¶ç»‘å®š ---
    $startBtn.on('click', startGame);
    $board.on('click', '.card', handleCardClick);

    // é¡µé¢åŠ è½½æ—¶åªåˆ›å»ºæ£‹ç›˜ï¼Œä¸å¼€å§‹æ¸¸æˆ
    initGame();
});
</script>
</body>
</html>