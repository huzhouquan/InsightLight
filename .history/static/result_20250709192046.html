<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è’™ç‰¹åˆ©å°”æµ‹è¯•ç»“æœæŠ¥å‘Š</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #3b82f6; --text-dark: #1f2937; --text-light: #6b7280;
            --bg-light: #f8f9fa; --bg-white: #ffffff; --border-color: #e5e7eb;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            font-family: var(--font-family); margin: 0; background-color: var(--bg-light);
            color: var(--text-dark);
        }
        header {
            width: 100%; background-color: var(--primary-color); color: white;
            padding: 1.5rem 0; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        header h1 { margin: 0; font-size: 1.8rem; }
        .container {
            max-width: 1200px; width: 95%; margin: 2rem auto;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* å·¦çª„å³å®½ */
            gap: 2rem;
            align-items: flex-start;
        }
        .card {
            background: var(--bg-white); border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 2rem;
        }
        .card h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        #radar-chart-container { position: relative; }
        #score-list { list-style: none; padding: 0; margin: 0; }
        #score-list li {
            display: flex; align-items: center; padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        #score-list li:last-child { border-bottom: none; }
        .score-item-icon { font-size: 1.5rem; margin-right: 1rem; width: 30px; text-align: center; }
        .score-item-details { flex-grow: 1; }
        .score-item-details strong { font-size: 1.1rem; }
        .score-item-details p { font-size: 0.9rem; color: var(--text-light); margin: 0.25rem 0 0; }
        .score-value { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .summary-card { grid-column: 1 / -1; margin-top: 2rem; } /* æ¨ªè·¨ä¸¤åˆ— */
        .summary-card p { line-height: 1.8; font-size: 1.1rem; }
        .loading-text { text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--text-light); }
        .back-link { display: inline-block; margin-top: 1rem; color: var(--primary-color); text-decoration: none; font-weight: bold; }
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; } /* åœ¨å°å±å¹•ä¸Šå˜ä¸ºå•åˆ— */
        }
    </style>
</head>
<body data-result-id="{{ result_id }}">
    
    <header>
        <h1>è®¤çŸ¥è¯„ä¼°æŠ¥å‘Š</h1>
    </header>

    <div class="container">
        <div class="main-layout">
            <div class="card" id="radar-chart-container">
                <h2>èƒ½åŠ›æ¦‚è§ˆ</h2>
                <canvas id="radarChart"></canvas>
            </div>
            <div class="card" id="details-container">
                <h2>å„é¡¹å¾—åˆ†è¯¦æƒ…</h2>
                <ul id="score-list">
                    <li id="loading-scores"><p class="loading-text">æ­£åœ¨åŠ è½½åˆ†æ•°...</p></li>
                </ul>
            </div>
        </div>
        <div class="card summary-card">
            <h2>ç»¼åˆåˆ†æä¸å»ºè®®</h2>
            <div id="analysis-text">
                <p class="loading-text">æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...</p>
            </div>
        </div>
        <a href="{% url 'frontendchoose' %}" class="back-link">è¿”å›æ¸¸æˆé€‰æ‹©é¡µ</a>
    </div>

    <script src="{% static 'jquery-3.7.1.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    $(document).ready(function() {

        // âœ… 1. å°†æ‚¨æä¾›çš„Pythonè¯„åˆ¤æ ‡å‡†ç¿»è¯‘æˆJavaScriptå¯¹è±¡
        const criteria = {
            subtest: {
                "(90, 100]": "è¡¨ç°éå¸¸å‡ºè‰²ï¼Œç»§ç»­ä¿æŒï¼",
                "(80, 90]": "è¡¨ç°è‰¯å¥½ï¼Œä»æœ‰æå‡ç©ºé—´ã€‚",
                "(70, 80]": "å¤„äºå¹³å‡æ°´å¹³ï¼Œå»ºè®®é€‚å½“ç»ƒä¹ ã€‚",
                "(60, 70]": "åŸºæœ¬è¾¾æ ‡ï¼Œå»ºè®®åŠ å¼ºè®­ç»ƒã€‚",
                "[0, 60]": "éœ€é‡ç‚¹å…³æ³¨ï¼Œå»ºè®®å®šæœŸå¤æŸ¥ã€‚"
            },
            overall: {
                "(90, 100]": "æ‚¨çš„è®¤çŸ¥åŠŸèƒ½çŠ¶æ€ä¼˜ç§€ï¼Œä¿æŒç°æœ‰ç”Ÿæ´»ä¹ æƒ¯å³å¯ã€‚",
                "(80, 90]": "è®¤çŸ¥åŠŸèƒ½è‰¯å¥½ï¼Œå°‘é‡é’ˆå¯¹æ€§è®­ç»ƒå¯è¿›ä¸€æ­¥æå‡ã€‚",
                "(70, 80]": "è®¤çŸ¥åŠŸèƒ½å¤„äºæ­£å¸¸èŒƒå›´ï¼Œå»ºè®®å¢åŠ ç›Šæ™ºæ´»åŠ¨ã€‚",
                "(60, 70]": "è®¤çŸ¥åŠŸèƒ½åŸºæœ¬æ­£å¸¸ï¼Œå»ºè®®åŒ»ç”ŸæŒ‡å¯¼ä¸‹è¿›è¡Œè®­ç»ƒã€‚",
                "[0, 60]": "å»ºè®®åˆ°ä¸“ä¸šæœºæ„è¿›ä¸€æ­¥è¯„ä¼°ï¼Œæ—©æœŸå¹²é¢„æ•ˆæœæ›´å¥½ã€‚"
            },
            MoCA_original: {
                "[26, 30]": "è®¤çŸ¥åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œè¯·ç»§ç»­ä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼ã€‚",
                "[21, 25]": "è®¤çŸ¥åŠŸèƒ½å­˜åœ¨è½»å¾®å˜åŒ–ï¼Œå»ºè®®æ¯å¹´å¤æŸ¥å¹¶åŠ å¼ºè„‘åŠ›æ´»åŠ¨ã€‚",
                "[10, 20]": "å»ºè®®åˆ°è®°å¿†é—¨è¯Šè¯¦ç»†æ£€æŸ¥ï¼Œæ—©æœŸå¹²é¢„å¾ˆé‡è¦ã€‚",
                "[0, 9]": "è¯·å°½å¿«å°±åŒ»è¯„ä¼°ï¼Œæˆ‘ä»¬ä¼šä¸ºæ‚¨åˆ¶å®šä¸ªæ€§åŒ–æ–¹æ¡ˆã€‚"
            }
        };

        const domainMap = {
            visuospatial: { name: "è§†ç©ºé—´", icon: "ğŸŒŒ" }, naming: { name: "å‘½å", icon: "âœï¸" },
            memory: { name: "è®°å¿†åŠ›", icon: "ğŸ§ " }, attention: { name: "æ³¨æ„åŠ›", icon: "ğŸ¯" },
            language: { name: "è¯­è¨€", icon: "ğŸ—£ï¸" }, abstraction: { name: "æŠ½è±¡", icon: "ğŸ’¡" },
            delayed_recall: { name: "å»¶è¿Ÿå›å¿†", icon: "â³" }, orientation: { name: "å®šå‘", icon: "ğŸ§­" }
        };

        // âœ… 2. åˆ›å»ºæ™ºèƒ½åˆ†æçš„è¾…åŠ©å‡½æ•°

        // æ ¹æ®åˆ†æ•°å’Œè§„åˆ™èŒƒå›´è·å–åé¦ˆæ–‡æœ¬
        function getFeedback(score, rules) {
            for (const range in rules) {
                const [min, max] = JSON.parse(range.replace('(', '[').replace(')', ']'));
                if (score > min && score <= max) return rules[range];
            }
            return "æš‚æ— è¯„ä¼°ã€‚";
        }
        
        // è®¡ç®—MoCAç­‰æ•ˆåˆ†æ•°ï¼ˆ8ä¸ªé¡¹ç›®ï¼Œæ¯é¡¹100åˆ†ï¼Œæ€»åˆ†800ï¼Œè½¬æ¢ä¸º30åˆ†åˆ¶ï¼‰
        function calculateMoCAEquivalentScore(scores) {
            let total = 0;
            let count = 0;
            for (const key in scores) {
                if (domainMap[key]) {
                    total += parseFloat(scores[key] || 0);
                    count++;
                }
            }
            if (count === 0) return 0;
            // (æ€»åˆ† / (é¡¹ç›®æ•° * 100)) * 30
            return (total / (count * 100)) * 30;
        }

        // ç”Ÿæˆå®Œæ•´çš„åˆ†ææŠ¥å‘Š
        function generateAnalysis(scores) {
            const mocaScore = calculateMoCAEquivalentScore(scores);
            const overallAverage = mocaScore / 30 * 100; // è½¬æ¢å›ç™¾åˆ†åˆ¶ç”¨äºoverallè¯„åˆ¤
            
            const overallFeedback = getFeedback(overallAverage, criteria.overall);
            const mocaFeedback = getFeedback(mocaScore, criteria.MoCA_original);
            
            return `
                <p><strong>ç»¼åˆè¯„ä¼° (åŸºäºMoCAæ ‡å‡†):</strong> æ‚¨çš„ç­‰æ•ˆåˆ†æ•°ä¸º <strong>${mocaScore.toFixed(1)} / 30</strong>ã€‚${mocaFeedback}</p>
                <p><strong>æ•´ä½“è¡¨ç°:</strong> ${overallFeedback}</p>
                <p><strong>è’™ç‰¹åˆ©å°”è®¤çŸ¥è¯„ä¼°ï¼ˆMoCAï¼‰ç®€ä»‹ ğŸ§ </p>
è’™ç‰¹åˆ©å°”è®¤çŸ¥è¯„ä¼°ï¼ˆMontreal Cognitive Assessmentï¼Œç®€ç§°MoCAï¼‰æ˜¯ä¸€ç§ä¸ºäº†å¸®åŠ©åŒ»ç–—ä¸“ä¸šäººå‘˜å¿«é€Ÿã€æœ‰æ•ˆåœ°ç­›æŸ¥è½»åº¦è®¤çŸ¥éšœç¢ (Mild Cognitive Impairment, MCI) å’Œæ—©æœŸé˜¿å°”èŒ¨æµ·é»˜ç—…è€Œè®¾è®¡çš„è¯„ä¼°å·¥å…·ã€‚å®ƒç›®å‰æ˜¯å…¨çƒèŒƒå›´å†…ä½¿ç”¨æœ€å¹¿æ³›çš„è®¤çŸ¥åŠŸèƒ½éšœç¢ç­›æŸ¥å·¥å…·ä¹‹ä¸€ã€‚</p>

å®ƒæµ‹è¯•å“ªäº›æ–¹é¢ï¼Ÿ</p>
MoCA é€šè¿‡ä¸€ç³»åˆ—ç®€çŸ­çš„ä»»åŠ¡ï¼Œæ—¨åœ¨å…¨é¢åœ°è¯„ä¼°å¤šä¸ªå…³é”®çš„è®¤çŸ¥é¢†åŸŸï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>

è§†ç©ºé—´ä¸æ‰§è¡ŒåŠŸèƒ½: é€šè¿‡è¿çº¿æµ‹è¯•ï¼ˆæŒ‰é¡ºåºè¿æ¥æ•°å­—å’Œå­—æ¯ï¼‰å’Œç”»ä¸€ä¸ªæŒ‡å®šçš„é’Ÿè¡¨æ¥è¯„ä¼°ã€‚</p>

å‘½åèƒ½åŠ›: è¾¨è®¤å¹¶è¯´å‡ºä¸€äº›å¸¸è§åŠ¨ç‰©çš„åç§°ï¼ˆä¾‹å¦‚ç‹®å­ã€çŠ€ç‰›ã€éª†é©¼ï¼‰ã€‚</p>

è®°å¿†åŠ›: çŸ­æ—¶è®°å¿†ä»»åŠ¡ï¼Œè¦æ±‚å—è¯•è€…å¬ä¸€ç»„è¯è¯­ï¼Œå¹¶åœ¨å‡ åˆ†é’Ÿåè¿›è¡Œå›å¿†ã€‚</p>

æ³¨æ„åŠ›: æµ‹è¯•ä¸“æ³¨åŠ›ï¼Œä¾‹å¦‚æ ¹æ®ç‰¹å®šå­—æ¯æ‹æ‰‹ï¼Œæˆ–è€…è¿›è¡Œè¿ç»­å‡æ³•è®¡ç®—ã€‚</p>

<p>è¯­è¨€èƒ½åŠ›: è¦æ±‚å—è¯•è€…å¤è¿°å¤æ‚çš„å¥å­ï¼Œä»¥åŠåœ¨ä¸€åˆ†é’Ÿå†…è¯´å‡ºå°½å¯èƒ½å¤šçš„ä»¥ç‰¹å®šå£°æ¯å¼€å¤´çš„è¯ã€‚</p>

<p>æŠ½è±¡æ€ç»´: è¦æ±‚å—è¯•è€…æè¿°ä¸¤ä¸ªè¯è¯­ä¹‹é—´çš„ç›¸ä¼¼ä¹‹å¤„ï¼ˆä¾‹å¦‚ï¼Œâ€œç«è½¦å’Œè‡ªè¡Œè½¦æœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿâ€ï¼‰ã€‚</p>

<p>å®šå‘åŠ›: å¯¹å½“å‰æ‰€åœ¨çš„å¹´ä»½ã€æœˆä»½ã€æ—¥æœŸå’Œåœ°ç‚¹çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚</p>

<p>æ€»åˆ†: MoCAçš„æ€»åˆ†ä¸º 30åˆ†ã€‚</p>

<p>æ­£å¸¸èŒƒå›´: é€šå¸¸ï¼Œå¾—åˆ† 26åˆ†åŠä»¥ä¸Šè¢«è®¤ä¸ºæ˜¯è®¤çŸ¥åŠŸèƒ½æ­£å¸¸ã€‚</p>

<p>æ•™è‚²å¹´é™æ ¡æ­£: MoCAçš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ï¼Œå¦‚æœå—è¯•è€…æ¥å—çš„æ­£è§„æ•™è‚²å¹´é™ä¸å¤šäº12å¹´ï¼Œå…¶æœ€ç»ˆæ€»åˆ†ä¼šé¢å¤–åŠ 1åˆ†ï¼Œä»¥æ ¡æ­£æ•™è‚²æ°´å¹³å¯¹æµ‹è¯•ç»“æœå¯èƒ½äº§ç”Ÿçš„å½±å“ã€‚</p>

<p>ä¸ºä»€ä¹ˆå®ƒå¾ˆé‡è¦ï¼Ÿ</p>
<p>ä¸ä¸€äº›æ›´æ—©çš„ç­›æŸ¥å·¥å…·ï¼ˆå¦‚ç®€æ˜“ç²¾ç¥çŠ¶æ€æ£€æŸ¥MMSEï¼‰ç›¸æ¯”ï¼ŒMoCAåœ¨æ£€æµ‹æ—©æœŸæˆ–è½»å¾®çš„è®¤çŸ¥é—®é¢˜ä¸Šæ›´ä¸ºæ•æ„Ÿï¼Œè¿™å¯¹äºåŠæ—©å‘ç°é£é™©ã€è¿›è¡Œæ—©æœŸå¹²é¢„è‡³å…³é‡è¦ã€‚</p>

<p>é‡è¦æç¤ºï¼š MoCAæ˜¯ä¸€ä¸ªç­›æŸ¥å·¥å…·ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè¯Šæ–­å·¥å…·ã€‚æµ‹è¯•åˆ†æ•°åä½ä»…è¡¨ç¤ºâ€œå¯èƒ½å­˜åœ¨è®¤çŸ¥æŸå®³çš„é£é™©ï¼Œéœ€è¦è¿›è¡Œæ›´å…¨é¢çš„ä¸“ä¸šè¯„ä¼°â€ï¼Œå®ƒæœ¬èº«å¹¶ä¸èƒ½ç›´æ¥ç¡®è¯Šä»»ä½•ç–¾ç—…ã€‚</p></strong></p>
                <p style="font-size:0.8rem; color:#999; margin-top:1rem;">*æ³¨æ„: æœ¬ç»“æœä»…ä¸ºåŸºäºæ¸¸æˆçš„è®¤çŸ¥èƒ½åŠ›æ¨¡æ‹Ÿè¯„ä¼°ï¼Œä¸èƒ½æ›¿ä»£ä»»ä½•ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚å¦‚æœ‰ç–‘è™‘ï¼Œè¯·å’¨è¯¢åŒ»ç”Ÿã€‚*</p>
            `;
        }

        // âœ… 3. é‡æ„é¡µé¢æ¸²æŸ“é€»è¾‘

        // æ¸²æŸ“é›·è¾¾å›¾
        function renderRadarChart(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = Object.keys(domainMap).map(key => domainMap[key].name);
            const data = Object.keys(domainMap).map(key => scores[key] || 0);

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'èƒ½åŠ›å¾—åˆ†',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // æ›´æ–°åˆ†æ•°è¯¦æƒ…åˆ—è¡¨
        function updateScoreDetails(scores) {
            const $list = $('#score-list');
            $list.html(''); // æ¸…ç©ºåŠ è½½æç¤º
            
            for (const key in domainMap) {
                const score = scores[key] || 0;
                const subtestFeedback = getFeedback(score, criteria.subtest).replace('xxx', domainMap[key].name);
                const listItem = `
                    <li>
                        <span class="score-item-icon">${domainMap[key].icon}</span>
                        <div class="score-item-details">
                            <strong>${domainMap[key].name}</strong>
                            <p>${subtestFeedback}</p>
                        </div>
                        <span class="score-value">${score.toFixed(0)}</span>
                    </li>
                `;
                $list.append(listItem);
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–å‡½æ•°
        function initPage() {
            const resultId = $('body').data('result-id');
            if (!resultId) {
                alert("æœªæ‰¾åˆ°æµ‹è¯•ç»“æœIDï¼");
                return;
            }
            
            $.ajax({
                url: `/api/results/${resultId}/`,
                method: 'GET',
                success: function(response) {
                    renderRadarChart(response);
                    updateScoreDetails(response);
                    const analysisHTML = generateAnalysis(response);
                    $('#analysis-text').html(analysisHTML);
                },
                error: function(error) {
                    console.error("è·å–ç»“æœå¤±è´¥:", error);
                    alert("æ— æ³•åŠ è½½æµ‹è¯•ç»“æœã€‚");
                }
            });
        }

        initPage(); // æ‰§è¡Œï¼
    });
    </script>
</body>
</html>