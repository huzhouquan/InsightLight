<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>è®°å¿†æ£‹ç›˜æ¸¸æˆ (æ—¶é—´è®¡åˆ†ç‰ˆ)</title>
    <style>
        .home-button-container { position: fixed; left: 40px; bottom: 40px; z-index: 1000; }
        .home-button-container .btn { background-color: #10b981; padding: 12px 30px; font-size: 1.1rem; font-weight: 500; color: white; text-decoration: none; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            color: rgb(0, 0, 0);
            font-size: 1.1rem;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none; /* åˆå§‹éšè— */
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        .toast-notification.show {
            display: block;
            top: 40px;
            opacity: 1;
        }
        .toast-notification.success {
            background-color: #28a745; /* æˆåŠŸç»¿è‰² */
        }
        .toast-notification.error {
            background-color: #dc3545; /* å¤±è´¥çº¢è‰² */
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; text-align: center; background: #f0f4f8; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h1 { margin-bottom: 10px; color: #1f2937; }
        .instructions { color: #4b5563; margin-bottom: 20px; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 15px; justify-content: center; margin: 20px auto; }
        .card { width: 100px; height: 100px; background-color: #3b82f6; color: white; font-size: 3rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 10px; transition: transform 0.4s; transform-style: preserve-3d; }
        .card .card-face { backface-visibility: hidden; position: absolute; }
        .card .card-back { transform: rotateY(180deg); }
        .card.flipped { transform: rotateY(180deg); background-color: #eb9124; }
        .card.matched { background-color: #10b981; cursor: default; transform: rotateY(180deg) scale(1.05); }
        #message { margin-top: 20px; font-size: 1.5rem; font-weight: bold; min-height: 1.5em; }
        button { padding: 12px 30px; font-size: 1.1rem; background-color: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* âœ… æ–°å¢1: â€œä¸‹ä¸€é¢˜â€æŒ‰é’®çš„å®¹å™¨æ ·å¼ */
        .next-button-container {
            position: fixed;
            right: 40px;
            bottom: 40px;
            z-index: 1000;
        }
        .next-button-container .btn {
            background-color: #10b981; /* ç»¿è‰² */
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }
        .next-button-container .btn:hover {
            background-color: #0f9d58;
            transform: translateY(-2px);
        }
    </style>
</head>

<body data-result-id="{{ result_id }}">
<div id="toast" class="toast-notification"></div>
<div class="container">
    <h1>è®°å¿†æ£‹ç›˜</h1>
    <p class="instructions">æ‰¾å‡ºæ‰€æœ‰åŒ¹é…çš„å¡ç‰‡é…å¯¹ï¼Œç”¨æ—¶è¶ŠçŸ­ï¼Œå¾—åˆ†è¶Šé«˜ï¼</p>
    <div class="board" id="board"></div>
    <div id="message"></div>
    <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
</div>

<div class="next-button-container" style="display: none;">
    {% if next_game_url %}
        <a href="{{ next_game_url }}" class="btn">ä¸‹ä¸€é¢˜</a>
    {% else %}
        <a href="{% url 'frontendchoose' %}" class="btn">å®Œæˆï¼è¿”å›é€‰æ‹©é¡µ</a>
    {% endif %}
</div>
<div class="home-button-container">
    {% if next_game_url %}
        <a href="{{ home_url }}" class="btn">è¿”å›ä¸»é¡µ</a>
    {% endif %}
</div>


<script src="{% static 'jquery-3.7.1.min.js' %}"></script>
<script>
$(document).ready(function() {
    
    // --- æ¸¸æˆçŠ¶æ€å’Œé…ç½® ---
    const gridRows = 2;
    const gridCols = 3;
    const totalPairs = (gridRows * gridCols) / 2;
    let gameState = {};

    // --- DOM å…ƒç´ ç¼“å­˜ ---
    const $board = $('#board');
    const $message = $('#message');
    const $startBtn = $('#startBtn');

    // âœ… ä¿®æ”¹3: åœ¨ initGame ä¸­ç¡®ä¿â€œä¸‹ä¸€é¢˜â€æŒ‰é’®è¢«éšè—
    function initGame() {
        gameState = {
            cards: generateCardData(), flippedCards: [], matchedPairs: 0,
            isGameActive: false, startTime: 0
        };
        
        $board.html('');
        gameState.cards.forEach((cardData, index) => {
            const $card = $(`<div class="card" data-index="${index}" data-value="${cardData.value}"><div class="card-face card-front"></div><div class="card-face card-back">${cardData.value}</div></div>`);
            $board.append($card);
        });

        $message.text('');
        $startBtn.prop('disabled', false).show().text('å¼€å§‹æ¸¸æˆ');
        $('.next-button-container').hide(); // ç¡®ä¿æŒ‰é’®åœ¨é‡ç½®æ—¶éšè—
    }

    // (startGame, handleCardClick, checkMatch, calculateScore ç­‰å‡½æ•°ä¿æŒä¸å˜)
    function generateCardData() { const values = []; const symbols = ['â˜…', 'â™¥', 'â™¦']; for (let i = 0; i < totalPairs; i++) { values.push({ value: symbols[i] }, { value: symbols[i] }); } return values.sort(() => Math.random() - 0.5); }
    function startGame() { initGame(); $startBtn.hide(); $message.text('æ‰¾å‡ºæ‰€æœ‰é…å¯¹ï¼'); gameState.isGameActive = true; gameState.startTime = Date.now(); }
    function handleCardClick() { if (!gameState.isGameActive || gameState.flippedCards.length >= 2) return; const $card = $(this); if ($card.hasClass('flipped')) return; $card.addClass('flipped'); gameState.flippedCards.push($card); if (gameState.flippedCards.length === 2) { checkMatch(); } }
    function checkMatch() { const [$card1, $card2] = gameState.flippedCards; if ($card1.data('value') === $card2.data('value')) { $card1.addClass('matched'); $card2.addClass('matched'); gameState.matchedPairs++; gameState.flippedCards = []; if (gameState.matchedPairs === totalPairs) { finishGame(); } } else { setTimeout(() => { $card1.removeClass('flipped'); $card2.removeClass('flipped'); gameState.flippedCards = []; }, 1000); } }
    function finishGame() { gameState.isGameActive = false; const elapsedMilliseconds = Date.now() - gameState.startTime; const elapsedSeconds = elapsedMilliseconds / 1000; const finalScore = calculateScore(elapsedSeconds); $message.text(`ğŸ‰ å®Œæˆï¼ç”¨æ—¶: ${elapsedSeconds.toFixed(2)}ç§’ï¼Œå¾—åˆ†: ${finalScore}`).css('color', 'green'); const currentResultId = $('body').data('result-id'); updateResult(currentResultId, { "delayed_recall": finalScore }); $startBtn.text('å†ç©ä¸€æ¬¡').show(); }
    function calculateScore(elapsedSeconds) {
    // 30ç§’ä»¥å†…ï¼Œéƒ½æ˜¯æ»¡åˆ†
    if (elapsedSeconds <= 30) {
        return 100;
    }
    // 5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰æˆ–ä»¥ä¸Šï¼Œéƒ½æ˜¯æœ€ä½åˆ†50åˆ†
    if (elapsedSeconds >= 300) {
        return 50;
    }

    // åœ¨30ç§’åˆ°300ç§’ä¹‹é—´ï¼Œåˆ†æ•°ä»100åˆ†çº¿æ€§é€’å‡åˆ°50åˆ†
    // æ€»æ—¶é•¿èŒƒå›´ = 300 - 30 = 270ç§’
    // æ€»åˆ†å·®èŒƒå›´ = 100 - 50 = 50åˆ†
    const score = 100 - ((elapsedSeconds - 30) / 270) * 50;

    return Math.round(score); // è¿”å›ä¸€ä¸ªæ•´æ•°
}
    // âœ… ä¿®æ”¹4: åœ¨ updateResult çš„ success å›è°ƒä¸­æ˜¾ç¤ºæŒ‰é’®
    function showNotification(message, type) {
            const $toast = $('#toast');
            // è®¾ç½®æ¶ˆæ¯å’Œæ ·å¼ (success æˆ– error)
            $toast.text(message).removeClass('success error').addClass(type);
            
            // æ˜¾ç¤ºå¹¶è§¦å‘CSSåŠ¨ç”»
            $toast.addClass('show');

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(function() {
                $toast.removeClass('show');
            }, 3000);
        }
        function updateResult(resultId, dataToUpdate) {
            if (!resultId) { console.error("IDä¸å­˜åœ¨!"); return; }
            $.ajax({
                url: `/api/results/${resultId}/`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify(dataToUpdate),
                success: function(response) {
                    console.log('æ›´æ–°æˆåŠŸ!', response);
                    showNotification('åˆ†æ•°å·²æˆåŠŸæäº¤ï¼', 'success');
                    // âœ… æ–°å¢3: AJAXè¯·æ±‚æˆåŠŸåï¼Œæ˜¾ç¤ºâ€œä¸‹ä¸€é¢˜â€æŒ‰é’®
                    $('.next-button-container').show();
                    $('#checkDateBtn').prop('disabled', true); // ç¦ç”¨â€œç¡®è®¤æ—¥æœŸâ€æŒ‰é’®
                },
                error: function(error) {
                    console.error('æ›´æ–°å¤±è´¥:', error);
                    showNotification('æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
                }
            });
        }
    // --- äº‹ä»¶ç»‘å®š ---
    $startBtn.on('click', startGame);
    $board.on('click', '.card', handleCardClick);

    // é¡µé¢åŠ è½½æ—¶åªåˆ›å»ºæ£‹ç›˜
    initGame();
});
</script>
</body>
</html>